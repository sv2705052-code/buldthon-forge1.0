<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Portal - MessFlow</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <nav class="bg-indigo-700 text-white p-5 shadow-lg">
    <div class="container flex justify-between items-center">
      <h1 class="text-2xl font-bold">MessFlow Student Portal</h1>
      <button onclick="logout()" class="btn btn-danger px-6 py-2">Logout</button>
    </div>
  </nav>

  <div class="container py-10">
    <div class="card">
      <h2 class="text-3xl font-bold text-indigo-800 mb-6">Welcome, <span id="rollDisplay"></span></h2>

      <div class="bg-white rounded-xl shadow p-6 mb-8">
        <p class="text-2xl font-semibold text-green-700">
          Current Total Mess Dues: <span id="dues" class="text-3xl">₹3200</span>
        </p>
      </div>

      <!-- Date selection for viewing attendance & extras -->
      <div class="card mb-8">
        <h3 class="text-2xl font-bold text-indigo-700 mb-6">View Record for Specific Date</h3>
        
        <div class="flex flex-col sm:flex-row gap-4 items-end mb-6">
          <div class="flex-1">
            <label class="block text-lg font-medium text-gray-700 mb-2">Select Date</label>
            <input type="date" id="viewDate" class="w-full p-4 border rounded-lg text-lg" required>
          </div>
          <button onclick="loadStudentData()" class="btn btn-primary px-8 py-4 text-lg whitespace-nowrap">
            Load / Refresh
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            <h4 class="text-xl font-semibold text-indigo-700 mb-4">Attendance on Selected Date</h4>
            <div id="attendance" class="space-y-3 text-lg bg-gray-50 p-5 rounded-lg"></div>
          </div>

          <div>
            <h4 class="text-xl font-semibold text-indigo-700 mb-4">Extras on Selected Date</h4>
            <ul id="extras" class="space-y-3 bg-gray-50 p-5 rounded-lg"></ul>
          </div>
        </div>
      </div>

      <!-- Feedback section remains global -->
      <div class="card">
        <h3 class="text-2xl font-bold text-indigo-700 mb-6">Submit Food Quality Feedback</h3>
        <select id="rating" class="w-full p-4 border rounded-lg mb-4 text-lg">
          <option value="5">5 ★ Excellent</option>
          <option value="4">4 ★ Good</option>
          <option value="3">3 ★ Average</option>
          <option value="2">2 ★ Poor</option>
          <option value="1">1 ★ Very Bad</option>
        </select>
        <textarea id="comment" placeholder="Your comments about food quality..." class="w-full p-4 border rounded-lg h-32 mb-4 text-lg"></textarea>
        <button onclick="submitFeedback()" class="btn btn-primary w-full py-4 text-lg">Submit Feedback</button>
      </div>
    </div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (user.role !== 'student' || !user.roll) {
      window.location.href = 'index.html';
    }

    document.getElementById('rollDisplay').textContent = user.roll;

    // Set default date to today
    document.getElementById('viewDate').value = new Date().toISOString().split('T')[0];

    function getStudents() {
      return JSON.parse(localStorage.getItem('mess_students') || '{}');
    }

    function saveStudents(data) {
      localStorage.setItem('mess_students', JSON.stringify(data));
    }

    function loadStudentData() {
      const students = getStudents();
      const student = students[user.roll] || {
        dues: 3200,
        attendance: {},
        extras: [],
        feedback: []
      };

      // Update total dues (global)
      document.getElementById('dues').textContent = `₹${student.dues || 3200}`;

      // Get selected date
      const selectedDate = document.getElementById('viewDate').value;
      if (!selectedDate) return;

      // Attendance for selected date
      const att = student.attendance[selectedDate] || { breakfast: false, lunch: false, dinner: false };

      const attDiv = document.getElementById('attendance');
      attDiv.innerHTML = `
        <div class="flex justify-between">
          <span>Breakfast:</span>
          <span class="${att.breakfast ? 'att-present' : 'att-absent'} font-medium">
            ${att.breakfast ? 'Present' : 'Not marked / Absent'}
          </span>
        </div>
        <div class="flex justify-between">
          <span>Lunch:</span>
          <span class="${att.lunch ? 'att-present' : 'att-absent'} font-medium">
            ${att.lunch ? 'Present' : 'Not marked / Absent'}
          </span>
        </div>
        <div class="flex justify-between">
          <span>Dinner:</span>
          <span class="${att.dinner ? 'att-present' : 'att-absent'} font-medium">
            ${att.dinner ? 'Present' : 'Not marked / Absent'}
          </span>
        </div>
      `;

      // Extras only for selected date
      const extrasUl = document.getElementById('extras');
      const dateExtras = (student.extras || []).filter(ex => ex.date === selectedDate);

      extrasUl.innerHTML = dateExtras.length === 0 
        ? '<li class="text-gray-500 italic">No extra items recorded on this date</li>'
        : dateExtras.map(ex => `
            <li class="flex justify-between text-base">
              <span>${ex.item}</span>
              <span class="text-red-600 font-medium">₹${ex.price}</span>
            </li>
          `).join('');
    }

    function submitFeedback() {
      const rating = document.getElementById('rating').value;
      const comment = document.getElementById('comment').value.trim();
      if (!comment) return alert('Please write a comment');

      const students = getStudents();
      let student = students[user.roll] || { dues: 3200, attendance: {}, extras: [], feedback: [] };

      student.feedback = student.feedback || [];
      student.feedback.push({
        rating: Number(rating),
        comment,
        date: new Date().toLocaleString()
      });

      students[user.roll] = student;
      saveStudents(students);

      alert('Feedback submitted successfully!');
      document.getElementById('comment').value = '';
    }

    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    }

    // Load data on page open
    loadStudentData();
  </script>
</body>
</html>